# Инструкция по использованию Liquibase

## Основные принципы

### ✅ Старые таблицы сохраняются автоматически!

Когда вы добавляете новую таблицу через Liquibase, **все существующие таблицы и их данные остаются нетронутыми**. Это работает автоматически благодаря настройке `drop-first: false` в `application.yml`.

## Структура проекта

Проект использует **YAML формат** для master changelog и **SQL формат** для миграций.

```
db/changelog/
├── db.changelog-master.yaml         # Главный файл (YAML формат)
├── README.md                         # Подробная документация (англ.)
├── ИНСТРУКЦИЯ.md                    # Эта инструкция (рус.)
└── changeset/
    ├── products_V001__initial.sql              # Создание таблицы products
    ├── categories_V001__initial.sql            # Создание таблицы categories
    ├── products_V002__add_category_id.sql      # Изменение таблицы products
    └── ...
```

## Правила именования файлов

Формат: `{table_name}_V{номер}__{описание}.sql`

Примеры:
- `products_V001__initial.sql` - создание таблицы products
- `products_V002__add_category_id.sql` - добавление колонки в products
- `user_V001__initial.sql` - создание таблицы user
- `user_V002__update_user_add_profile_pic.sql` - обновление таблицы user

## Как добавить новую таблицу (пошагово)

### Шаг 1: Создайте SQL файл

Создайте файл в папке `changeset/` с правильным именем:

**Пример:** `user_V001__initial.sql`

```sql
--liquibase formatted sql

--changeset ihome24:user_V001__initial
--comment: Создание таблицы user

CREATE TABLE user (
    id BIGSERIAL PRIMARY KEY NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE INDEX idx_user_email ON user(email);

--rollback DROP TABLE IF EXISTS user CASCADE;
```

### Шаг 2: Добавьте в master changelog

Откройте `db.changelog-master.yaml` и добавьте в конец:

```yaml
databaseChangeLog:
  - include:
      file: db/changelog/changeset/products_V001__initial.sql
  - include:
      file: db/changelog/changeset/user_V001__initial.sql  # ← Добавьте здесь
```

**Важно:** Сохраняйте порядок! Новые миграции добавляются в конец списка.

### Шаг 3: Запустите приложение

При запуске Spring Boot автоматически применит новую миграцию. Таблица `products` останется нетронутой!

## Как изменить существующую таблицу

**ВАЖНО:** Никогда не изменяйте уже примененные changeset файлы!

Вместо этого создайте **новый файл** с увеличенным номером версии:

**Пример:** Добавить колонку в таблицу `products`

Создайте `products_V002__add_new_column.sql`:

```sql
--liquibase formatted sql

--changeset ihome24:products_V002__add_new_column
--comment: Добавление колонки в таблицу products

ALTER TABLE products ADD COLUMN new_column VARCHAR(255);

--rollback ALTER TABLE products DROP COLUMN IF EXISTS new_column;
```

Затем добавьте в `db.changelog-master.yaml`:
```yaml
  - include:
      file: db/changelog/changeset/products_V002__add_new_column.sql
```

## Правила именования

### ChangeSet ID
- Должен быть **уникальным**
- **Никогда не изменяется** после применения
- Формат: `{table_name}_V{номер}__{описание}`

### Имена файлов
- Формат: `{table_name}_V{номер}__{описание}.sql`
- Последовательные номера версий: `V001`, `V002`, `V003`
- Описательные имена: `initial`, `add_category_id`, `update_user_profile`

## Проверка миграций

### Посмотреть SQL без применения:
```bash
cd backend
mvn liquibase:updateSQL
```

### Статус миграций:
```bash
mvn liquibase:status
```

## Частые операции

### Создать таблицу
```sql
--liquibase formatted sql
--changeset ihome24:table_V001__initial
CREATE TABLE table_name (
    id BIGSERIAL PRIMARY KEY NOT NULL,
    ...
);
--rollback DROP TABLE IF EXISTS table_name CASCADE;
```

### Добавить колонку
```sql
--liquibase formatted sql
--changeset ihome24:products_V002__add_column
ALTER TABLE products ADD COLUMN new_column VARCHAR(255);
--rollback ALTER TABLE products DROP COLUMN IF EXISTS new_column;
```

### Изменить тип колонки
```sql
--liquibase formatted sql
--changeset ihome24:products_V002__modify_column
ALTER TABLE products ALTER COLUMN name TYPE VARCHAR(500);
--rollback ALTER TABLE products ALTER COLUMN name TYPE VARCHAR(255);
```

### Создать индекс
```sql
--liquibase formatted sql
--changeset ihome24:products_V002__add_index
CREATE INDEX idx_products_name ON products(name);
--rollback DROP INDEX IF EXISTS idx_products_name;
```

### Добавить внешний ключ
```sql
--liquibase formatted sql
--changeset ihome24:products_V002__add_foreign_key
ALTER TABLE products 
ADD CONSTRAINT fk_products_category 
FOREIGN KEY (category_id) REFERENCES categories(id);
--rollback ALTER TABLE products DROP CONSTRAINT IF EXISTS fk_products_category;
```

## Важные напоминания

1. ✅ **Старые таблицы сохраняются автоматически** - `drop-first: false` в `application.yml`
2. ✅ Каждый changeset в **отдельном SQL файле**
3. ✅ Используйте **последовательную нумерацию** (V001, V002, V003...)
4. ✅ **Никогда не изменяйте** уже примененные changeset файлы
5. ✅ Для изменений создавайте **новые changeset файлы** с увеличенным номером версии
6. ✅ **Всегда указывайте rollback** в SQL файлах
7. ✅ Все changeset подключаются в **master changelog по порядку**

## Примеры в проекте

- `products_V001__initial.sql` - создание таблицы products
- `categories_V001__initial.sql` - создание таблицы categories
- `products_V002__add_category_id.sql` - добавление внешнего ключа в products

## Конфигурация

В `application.yml` уже настроено правильно:

```yaml
spring:
  liquibase:
    enabled: true
    change-log: classpath:db/changelog/db.changelog-master.yaml
    drop-first: false  # ✅ Это гарантирует сохранение данных!
```

## Почему SQL формат?

Проект использует **SQL формат** для миграций, потому что:
- ✅ Более читаемый и понятный для разработчиков
- ✅ Прямой доступ к возможностям PostgreSQL
- ✅ Легче писать сложные запросы и функции
- ✅ Проще мигрировать данные
- ✅ Rollback указывается явно в комментариях

**Формат master changelog - YAML**, что делает его более читаемым и удобным для управления списком миграций.

## Вопросы?

- Подробная документация: `README.md`
- Примеры: папка `changeset/`
